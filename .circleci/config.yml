version: 2
jobs:
  build:
    docker:
      - image: idubrov/rust-stm32:latest
    steps:
      - checkout
      - run: cargo build
      - run: cargo test
      - run: cargo clippy
      - run:
          name: Running code coverage
          command: |
            for file in target/debug/lcd-*[^\.d]; do
              mkdir -p "target/cov/$(basename $file)"
              kcov --exclude-pattern=/usr/local/cargo,/usr/lib --verify target/cov "$file"
            done
      - run:
          name: Uploading code coverage
          command: |
              bash <(curl -s https://codecov.io/bash)